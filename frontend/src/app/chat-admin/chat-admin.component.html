<div class="admin-chat-container">
  <!-- Sidebar with sessions list -->
  <div class="admin-chat-sidebar">
    <h3>Conversaciones activas</h3>

    <!-- Botón para borrar sesiones antiguas con mejor estilo -->
    <div class="admin-actions">
      <button class="btn-delete-old" (click)="confirmBulkDelete()">
        <i class="fas fa-trash"></i> Borrar chats antiguos
      </button>
    </div>

    <div *ngIf="loading" class="loading-indicator">
      <i class="fas fa-spinner fa-spin"></i> Cargando conversaciones...
    </div>

    <div *ngIf="!loading && sessions.length === 0" class="no-sessions">
      <i class="fas fa-comments"></i>
      <p>No hay conversaciones activas en este momento.</p>
    </div>

    <div class="session-list">
      <div *ngFor="let session of sessions"
           class="session-item"
           [class.active]="session.session_id === selectedSessionId"
           (click)="selectSession(session.session_id)">
        <div class="session-info">
          <div class="session-header">
            <span class="user-name">{{ session.user_name || session.user_id }}</span>
            <span class="session-time">{{ formatTime(session.last_message_time) }}</span>
          </div>
          <div class="session-preview">
            {{ session.last_message || 'No hay mensajes' }}
          </div>
        </div>
        <div class="session-actions">
          <button class="btn-delete" (click)="confirmDeleteSession(session.session_id, $event)" title="Borrar chat">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div *ngIf="session.unread_count > 0" class="unread-badge">
          {{ session.unread_count }}
        </div>
      </div>
    </div>
  </div>

  <!-- Main chat area -->
  <div class="admin-chat-main">
    <div *ngIf="!selectedSessionId" class="no-session-selected">
      <i class="fas fa-comments"></i>
      <p>Selecciona una conversación para ver los mensajes.</p>
      <p>Las nuevas consultas de los usuarios aparecerán en la lista de la izquierda.</p>
    </div>

    <div *ngIf="selectedSessionId" class="chat-content">
      <div class="admin-chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-indicator">
          <i class="fas fa-spinner fa-spin"></i> Cargando mensajes...
        </div>

        <div *ngIf="!loading && messages.length === 0" class="no-messages">
          <i class="fas fa-comment-slash"></i>
          <p>No hay mensajes en esta conversación.</p>
        </div>

        <div class="messages-container">
          <div *ngFor="let message of messages" class="message-wrapper">
            <div class="message-item"
                 [class.admin-message]="message.is_admin"
                 [class.user-message]="!message.is_admin">
              <div class="message-content">
                {{ message.message }}
              </div>
              <div class="message-time">
                {{ formatTime(message.created_at) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="admin-chat-input">
        <textarea
          [(ngModel)]="newMessage"
          placeholder="Escribe un mensaje..."
          (keydown.enter)="handleEnterKey($event)">
        </textarea>
        <button (click)="sendMessage()" [disabled]="!newMessage.trim()">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para borrar una sesión con mejor estilo -->
  <div *ngIf="showDeleteConfirm" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar eliminación</h5>
          <button type="button" class="close" (click)="cancelDeleteSession()">&times;</button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar esta conversación? Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelDeleteSession()">Cancelar</button>
          <button type="button" class="btn btn-danger" [disabled]="deletingInProgress" (click)="deleteSession()">
            <span *ngIf="deletingInProgress"><i class="fas fa-spinner fa-spin"></i> Eliminando...</span>
            <span *ngIf="!deletingInProgress">Eliminar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación para borrar sesiones antiguas con mejor estilo -->
  <div *ngIf="showBulkDeleteConfirm" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Eliminar chats antiguos</h5>
          <button type="button" class="close" (click)="cancelBulkDelete()">&times;</button>
        </div>
        <div class="modal-body">
          <p>Esta acción eliminará todas las conversaciones más antiguas que el número de días especificado.</p>
          <div class="form-group">
            <label for="daysToKeep">Mantener chats de los últimos:</label>
            <div class="input-group">
              <input type="number" id="daysToKeep" class="form-control" [(ngModel)]="daysToKeep" min="1" max="365">
              <div class="input-group-append">
                <span class="input-group-text">días</span>
              </div>
            </div>
          </div>
          <p class="text-danger">¡Atención! Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelBulkDelete()">Cancelar</button>
          <button type="button" class="btn btn-danger" [disabled]="deletingInProgress" (click)="deleteOldSessions()">
            <span *ngIf="deletingInProgress"><i class="fas fa-spinner fa-spin"></i> Eliminando...</span>
            <span *ngIf="!deletingInProgress">Eliminar chats antiguos</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>