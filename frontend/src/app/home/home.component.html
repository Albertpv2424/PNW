<!-- Background div -->
<div class="background-container"></div>

<div class="main-layout">
  <!-- Use the new header component -->
  <app-header [username]="username" (logoutEvent)="logout()"></app-header>

  <div class="content-container">
    <!-- Left sidebar with leagues -->
    <aside class="sidebar">
      <h2>Competiciones destacadas</h2>
      <div class="leagues-list">
        @for (sport of sports; track sport.key) {
          <div class="league-item" [class.active]="selectedSportKey === sport.key" (click)="loadOdds(sport.key)">
            <div class="league-info">
              <img [src]="getCountryFlag(sport.country)"
                   [alt]="sport.country"
                   class="league-flag"
                   (error)="handleFlagError($event, sport.country)">
              <span class="league-name">{{ sport.title }}</span>
            </div>
            <span class="chevron">›</span>
          </div>
        }
      </div>
    </aside>

    <!-- Main content with matches -->
    <main class="main-content">
      <h1>Deportes Disponibles</h1>

      <div *ngIf="error" class="alert alert-danger">
        {{ error }}
      </div>

      <div *ngIf="loading" class="alert alert-info">
        Cargando datos...
      </div>

      <!-- Partidos destacados - Nueva sección -->
      <!-- Partidos destacados - Solo se muestran cuando no hay liga seleccionada -->
      <div class="featured-matches" *ngIf="!selectedSportKey && featuredMatches.length > 0">
        <h3>Partidos Destacados</h3>

        <div class="matches-grid">
          @for (event of featuredMatches; track event.home_team) {
            <div class="match-card">
              <div class="match-header">
                <span class="match-league">{{ event.league || event.sport_title }}</span>
                <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>

              <div class="match-teams">
                <div class="team home-team">
                  <div class="team-logo">
                    <img [src]="getTeamLogo(event.home_team)"
                         alt="{{ event.home_team }}"
                         class="team-badge"
                         (error)="handleTeamLogoError($event, event.home_team)">
                  </div>
                  <div class="team-name">{{ event.home_team }}</div>
                </div>
                <div class="vs">VS</div>
                <div class="team away-team">
                  <div class="team-logo">
                    <img [src]="getTeamLogo(event.away_team)"
                         alt="{{ event.away_team }}"
                         class="team-badge"
                         (error)="handleTeamLogoError($event, event.away_team)">
                  </div>
                  <div class="team-name">{{ event.away_team }}</div>
                </div>
              </div>

              <!-- Aplicando el nuevo diseño de cuotas a los partidos destacados -->
              <div class="match-odds-new">
                @if (event.bookmakers && event.bookmakers.length > 0 && event.bookmakers[0].markets && event.bookmakers[0].markets.length > 0) {
                  <div class="odds-container-new">
                    @for (outcome of getOrderedOutcomes(event.bookmakers[0].markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                      <div class="odd-column">
                        <div class="odd-label-new">{{ outcome.name === 'Draw' ? 'EMPATE' : (outcome.name === event.home_team ? 'LOCAL' : 'VISITANTE') }}</div>
                        <!-- Fix the button in the featured matches section -->
                        <button
                          class="odd-button-new"
                          [class.active]="isSelectionActive(event.id || '', outcome.name)"
                          (click)="openBetPopup(
                            outcome.name === 'Draw' ? 'Empate' : outcome.name,
                            event.bookmakers[0].markets[0].key,
                            outcome.price,
                            event.home_team,
                            event.away_team,
                            event.id || '',
                            event.league || event.sport_title
                          )"
                        >
                          {{ outcome.price }}
                        </button>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="no-odds-message">
                    No hay cuotas disponibles para este partido.
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Mensaje cuando no hay partidos seleccionados ni destacados -->
      <div class="welcome-message" *ngIf="!selectedSportKey && featuredMatches.length === 0">
        <h3>¡Bienvenido a PNW!</h3>
        <p>Selecciona una competición de la izquierda para ver los partidos disponibles.</p>
      </div>

      <!-- Partidos de la liga seleccionada -->
      @if (selectedSportKey) {
        <div class="selected-league">
          <h3>Cuotas para {{ getSelectedSportTitle() }}</h3>

          <div class="matches-grid">
            @for (event of odds; track event.home_team) {
              <div class="match-card">
                <div class="match-header">
                  <span class="match-league">{{ event.league || event.sport_title }}</span>
                  <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>

                <div class="match-teams">
                  <div class="team home-team">
                    <div class="team-logo">
                      <img [src]="getTeamLogo(event.home_team)"
                           alt="{{ event.home_team }}"
                           class="team-badge"
                           (error)="handleTeamLogoError($event, event.home_team)">
                    </div>
                    <div class="team-name">{{ event.home_team }}</div>
                  </div>
                  <div class="vs">VS</div>
                  <div class="team away-team">
                    <div class="team-logo">
                      <img [src]="getTeamLogo(event.away_team)"
                           alt="{{ event.away_team }}"
                           class="team-badge"
                           (error)="handleTeamLogoError($event, event.away_team)">
                    </div>
                    <div class="team-name">{{ event.away_team }}</div>
                  </div>
                </div>

                <!-- Nueva sección de cuotas mejorada -->
                <div class="match-odds-new">
                  @if (event.bookmakers && event.bookmakers.length > 0 && event.bookmakers[0].markets && event.bookmakers[0].markets.length > 0) {
                    <div class="odds-container-new">
                      @for (outcome of getOrderedOutcomes(event.bookmakers[0].markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                        <div class="odd-column">
                          <div class="odd-label-new">{{ outcome.name === 'Draw' ? 'EMPATE' : (outcome.name === event.home_team ? 'LOCAL' : 'VISITANTE') }}</div>
                          <!-- Fix the button in the selected league section -->
                          <button 
                            class="odd-button-new"
                            [class.active]="isSelectionActive(event.id || '', outcome.name)"
                            (click)="openBetPopup(
                              outcome.name === 'Draw' ? 'Empate' : outcome.name,
                              event.bookmakers[0].markets[0].key,
                              outcome.price,
                              event.home_team,
                              event.away_team,
                              event.id || '',
                              event.league || event.sport_title
                            )"
                          >
                            {{ outcome.price }}
                          </button>
                        </div>
                      }
                    </div>
                  } @else {
                    <div class="no-odds-message">
                      No hay cuotas disponibles para este partido.
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
    </main>
  </div>
</div>

<!-- Componente de pop-up de apuesta -->
<app-bet-popup
  [visible]="showBetPopup"
  [teamName]="selectedBet.teamName"
  [betType]="selectedBet.betType"
  [odds]="selectedBet.odds"
  [matchInfo]="selectedBet.matchInfo"
  (close)="closeBetPopup()"
  (placeBet)="placeBet($event)"
></app-bet-popup>

<!-- Añadir el componente de apuesta combinada al final -->
<app-combined-bet></app-combined-bet>

<!-- Update your ngFor to use the new tracking function -->
<div *ngFor="let match of featuredMatches; trackBy: trackByMatch">
  <!-- match content -->
</div>
