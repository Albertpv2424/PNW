<!-- Background div -->
<div class="background-container"></div>

<div class="main-layout">
  <!-- Use the new header component -->
  <app-header [username]="username" (logoutEvent)="logout()"></app-header>

  <div class="content-container">
    <!-- Left sidebar with leagues -->
    <aside class="sidebar">
      <h2>Competiciones destacadas</h2>
      <div class="leagues-list">
        @for (sport of sports; track sport.key) {
          <div class="league-item" [class.active]="selectedSportKey === sport.key" (click)="loadOdds(sport.key)">
            <div class="league-info">
              <img [src]="getCountryFlag(sport.country)" 
                   [alt]="sport.country" 
                   class="league-flag"
                   (error)="handleFlagError($event, sport.country)">
              <span class="league-name">{{ sport.title }}</span>
            </div>
            <span class="chevron">›</span>
          </div>
        }
      </div>
    </aside>

    <!-- Main content with matches -->
    <main class="main-content">
      <h1>Deportes Disponibles</h1>

      <div *ngIf="error" class="alert alert-danger">
        {{ error }}
      </div>

      <div *ngIf="loading" class="alert alert-info">
        Cargando datos...
      </div>

      @if (selectedSportKey) {
        <div class="selected-league">
          <h3>Cuotas para {{ getSelectedSportTitle() }}</h3>
          
          <div class="matches-grid">
            @for (event of odds; track event.home_team) {
              <div class="match-card">
                <div class="match-header">
                  <span class="match-league">{{ event.league || getSelectedSportTitle() }}</span>
                  <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                
                <div class="match-teams">
                  <div class="team home-team">
                    <div class="team-logo">
                      <img [src]="getTeamLogo(event.home_team)" 
                           alt="{{ event.home_team }}" 
                           class="team-badge" 
                           (error)="handleTeamLogoError($event, event.home_team)">
                    </div>
                    <div class="team-name">{{ event.home_team }}</div>
                  </div>
                  <div class="vs">VS</div>
                  <div class="team away-team">
                    <div class="team-logo">
                      <img [src]="getTeamLogo(event.away_team)" 
                           alt="{{ event.away_team }}" 
                           class="team-badge"
                           (error)="handleTeamLogoError($event, event.away_team)">
                    </div>
                    <div class="team-name">{{ event.away_team }}</div>
                  </div>
                </div>
                
                <div class="match-odds">
                  @if (event.bookmakers.length > 0) {
                    @for (bookmaker of event.bookmakers; track bookmaker.name) {
                      @if (bookmaker.markets && bookmaker.markets.length > 0) {
                        <div class="odds-container">
                          <!-- Ordenamos las cuotas: Local, Empate, Visitante -->
                          @for (outcome of getOrderedOutcomes(bookmaker.markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                            <button 
                              class="odd-button"
                              (click)="openBetPopup(
                                outcome.name === 'Draw' ? 'Empate' : outcome.name, 
                                outcome.name === 'Draw' ? 'Empate' : 'Ganador', 
                                outcome.price,
                                event.home_team,
                                event.away_team,
                                event.id || ''
                              )"
                            >
                              <div class="odd-label">{{ outcome.name === 'Draw' ? 'Empate' : outcome.name }}</div>
                              <div class="odd-value">{{ outcome.price }}</div>
                            </button>
                          }
                        </div>
                      }
                    }
                  } @else {
                    <div class="no-odds-message">
                      No hay cuotas disponibles para este partido.
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
    </main>
  </div>
</div>

<!-- Componente de pop-up de apuesta -->
<app-bet-popup
  [visible]="showBetPopup"
  [teamName]="selectedBet.teamName"
  [betType]="selectedBet.betType"
  [odds]="selectedBet.odds"
  [matchInfo]="selectedBet.matchInfo"
  (close)="closeBetPopup()"
  (placeBet)="placeBet($event)"
></app-bet-popup>

<!-- Añadir el componente de apuesta combinada al final -->
<app-combined-bet></app-combined-bet>