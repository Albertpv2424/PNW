<!-- Background div -->
<div class="background-container"></div>

<div class="main-layout">
  <!-- Use the new header component -->
  <app-header [username]="username" (logoutEvent)="logout()"></app-header>

  <div class="content-container">
    <!-- Left sidebar with leagues -->
    <aside class="sidebar">
      <h2>Competiciones destacadas</h2>
      <div class="leagues-list">
        <div class="leagues-list">
          <div 
            *ngFor="let sport of sports" 
            class="league-item" 
            [class.active]="selectedSportKey === sport.key"
            (click)="selectSport(sport.key)">
            <div class="league-info">
              <!-- Sport icon -->
              <span class="sport-icon">{{ getSportIcon(sport.key) }}</span>
              
              <!-- Country flag -->
              <img 
                *ngIf="sport.country" 
                class="league-flag" 
                [src]="getCountryFlag(sport.country)" 
                [alt]="sport.country" 
                (error)="handleFlagError($event, sport.country)">
                
              <span class="league-name">{{ sport.title }}</span>
            </div>
            <span class="chevron">›</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main content with matches -->
    <main class="main-content">
      <h1>Deportes Disponibles</h1>

      <div *ngIf="error" class="alert alert-danger">
        {{ error }}
      </div>

      <div *ngIf="loading" class="alert alert-info">
        Cargando datos...
      </div>

      <!-- Partidos destacados - Nueva sección -->
      <!-- Partidos destacados - Solo se muestran cuando no hay liga seleccionada -->
      <div class="featured-matches" *ngIf="!selectedSportKey && featuredMatches.length > 0">
        <h3>Partidos Destacados</h3>

        <div class="matches-grid">
          @for (event of featuredMatches; track event.home_team) {
            <div class="match-card">
              <div class="match-header">
                <span class="match-league">{{ event.league || event.sport_title }}</span>
                <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>

              <div class="match-teams">
                <div class="team home-team">
                  <!-- For featured matches section -->
                  <div class="team-logo">
                    <img *ngIf="isTennisPlayer(event.home_team)" 
                         [src]="getPlayerImage(event.home_team)"
                         alt="{{ event.home_team }}"
                         class="player-image"
                         (error)="handleTeamLogoError($event, event.home_team)">
                    <img *ngIf="!isTennisPlayer(event.home_team)"
                         [src]="getTeamLogo(event.home_team)"
                         alt="{{ event.home_team }}"
                         class="team-badge"
                         (error)="handleTeamLogoError($event, event.home_team)">
                  </div>
                  <div class="team-name">{{ event.home_team }}</div>
                </div>
                <div class="vs">VS</div>
                <div class="team away-team">
                  <div class="team-logo">
                    <!-- Fix: Add check for tennis player for away team -->
                    <img *ngIf="isTennisPlayer(event.away_team)" 
                         [src]="getPlayerImage(event.away_team)"
                         alt="{{ event.away_team }}"
                         class="player-image"
                         (error)="handleTeamLogoError($event, event.away_team)">
                    <img *ngIf="!isTennisPlayer(event.away_team)"
                         [src]="getTeamLogo(event.away_team)"
                         alt="{{ event.away_team }}"
                         class="team-badge"
                         (error)="handleTeamLogoError($event, event.away_team)">
                  </div>
                  <div class="team-name">{{ event.away_team }}</div>
                </div>
              </div>

              <!-- Aplicando el nuevo diseño de cuotas a los partidos destacados -->
              <div class="match-odds-new">
                @if (event.bookmakers && event.bookmakers.length > 0 && event.bookmakers[0].markets && event.bookmakers[0].markets.length > 0) {
                  <div class="odds-container-new">
                    @for (outcome of getOrderedOutcomes(event.bookmakers[0].markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                      <div class="odd-column" [class.active]="isSelectionActive(event.id || '', outcome.name)">
                        <div class="odd-label-new">{{ outcome.name === 'Draw' ? 'EMPATE' : (outcome.name === event.home_team ? 'LOCAL' : 'VISITANTE') }}</div>
                        <!-- Fix the button in the featured matches section -->
                        <button
                          class="odd-button-new"
                          [class.active]="isSelectionActive(event.id || '', outcome.name)"
                          (click)="openBetPopup(
                            outcome.name === 'Draw' ? 'Empate' : outcome.name,
                            event.bookmakers[0].markets[0].key,
                            outcome.price,
                            event.home_team,
                            event.away_team,
                            event.id || '',
                            event.league || event.sport_title
                          )"
                        >
                          {{ outcome.price }}
                        </button>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="no-odds-message">
                    No hay cuotas disponibles para este partido.
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Mensaje cuando no hay partidos seleccionados ni destacados -->
      <div class="welcome-message" *ngIf="!selectedSportKey && featuredMatches.length === 0">
        <h3>¡Bienvenido a PNW!</h3>
        <p>Selecciona una competición de la izquierda para ver los partidos disponibles.</p>
      </div>

      <!-- Partidos de la liga seleccionada -->
      @if (selectedSportKey) {
        <div class="selected-league">
          <h3>Cuotas para {{ getSelectedSportTitle() }}</h3>

          <div *ngIf="selectedSportKey && odds.length > 0" class="matches-container">
            <h2>{{ getSelectedSportTitle() }}</h2>
            
            <div class="matches-grid">
              @for (event of odds; track event.id) {
                <div class="match-card">
                  <div class="match-header">
                    <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
                    <span class="match-league">{{ event.league || event.sport_title }}</span>
                  </div>
                  
                  <!-- Special handling for tennis matches -->
                  <div class="match-teams" [class.tennis-match]="selectedSportKey === 'tennis_atp_miami_open'">
                    <div class="team home-team">
                      <!-- For selected league section - home team -->
                      <div class="team-logo">
                        <img *ngIf="isTennisPlayer(event.home_team)" 
                             [src]="getPlayerImage(event.home_team)"
                             alt="{{ event.home_team }}"
                             class="player-image"
                             (error)="handleTeamLogoError($event, event.home_team)">
                        <img *ngIf="!isTennisPlayer(event.home_team)"
                             [src]="getTeamLogo(event.home_team)"
                             alt="{{ event.home_team }}"
                             class="team-badge"
                             (error)="handleTeamLogoError($event, event.home_team)">
                      </div>
                      <div class="team-name">{{ event.home_team }}</div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="team away-team">
                      <!-- For selected league section - away team -->
                      <div class="team-logo">
                        <img *ngIf="isTennisPlayer(event.away_team)" 
                             [src]="getPlayerImage(event.away_team)"
                             alt="{{ event.away_team }}"
                             class="player-image"
                             (error)="handleTeamLogoError($event, event.away_team)">
                        <img *ngIf="!isTennisPlayer(event.away_team)"
                             [src]="getTeamLogo(event.away_team)"
                             alt="{{ event.away_team }}"
                             class="team-badge"
                             (error)="handleTeamLogoError($event, event.away_team)">
                      </div>
                      <div class="team-name">{{ event.away_team }}</div>
                    </div>
                  </div>
                  
                  <!-- Nueva sección de cuotas mejorada -->
                  <div class="match-odds-new">
                    @if (event.bookmakers && event.bookmakers.length > 0 && event.bookmakers[0].markets && event.bookmakers[0].markets.length > 0) {
                      <div class="odds-container-new">
                        @for (outcome of getOrderedOutcomes(event.bookmakers[0].markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                          <div class="odd-column">
                            <div class="odd-label-new">{{ outcome.name === 'Draw' ? 'EMPATE' : (outcome.name === event.home_team ? 'LOCAL' : 'VISITANTE') }}</div>
                            <!-- Fix the button in the selected league section -->
                            <button 
                              class="odd-button-new"
                              [class.active]="isSelectionActive(event.id || '', outcome.name)"
                              (click)="openBetPopup(
                                outcome.name === 'Draw' ? 'Empate' : outcome.name,
                                event.bookmakers[0].markets[0].key,
                                outcome.price,
                                event.home_team,
                                event.away_team,
                                event.id || '',
                                event.league || event.sport_title
                              )"
                            >
                              {{ outcome.price }}
                            </button>
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="no-odds-message">
                        No hay cuotas disponibles para este partido.
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </main>
  </div>
</div>

<!-- Componente de pop-up de apuesta -->
<app-bet-popup
  [visible]="showBetPopup"
  [teamName]="selectedBet.teamName"
  [betType]="selectedBet.betType"
  [odds]="selectedBet.odds"
  [matchInfo]="selectedBet.matchInfo"
  (close)="closeBetPopup()"
  (placeBet)="placeBet($event)"
></app-bet-popup>

<!-- Añadir el componente de apuesta combinada al final -->
<app-combined-bet></app-combined-bet>

<!-- Update your ngFor to use the new tracking function -->
<div *ngFor="let match of featuredMatches; trackBy: trackByMatch">
  <!-- match content -->
</div>

<div class="user-menu" *ngIf="isMenuOpen">
  <ul>
    <li>
      <a routerLink="/profile">
        <i class="fas fa-user"></i> Mi Perfil
      </a>
    </li>
    <li>
      <a routerLink="/bets">
        <i class="fas fa-gamepad"></i> Mis Apuestas
      </a>
    </li>
    <li>
      <a routerLink="/history">
        <i class="fas fa-history"></i> Historial
      </a>
    </li>
    <li>
      <a routerLink="/profile/edit">
        <i class="fas fa-edit"></i> Editar Perfil
      </a>
    </li>
    <!-- Add Admin Dashboard option if user is admin -->
    <li *ngIf="authService.isAdmin()">
      <a routerLink="/admin/dashboard">
        <i class="fas fa-tachometer-alt"></i> Admin
      </a>
    </li>
    <li class="divider"></li>
    <li>
      <a (click)="logout()">
        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
      </a>
    </li>
  </ul>
</div>
