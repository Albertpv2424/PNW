<!-- Background div -->
<div class="background-container"></div>


<div class="main-layout">
  <!-- Use the new header component -->
  <app-header [username]="username" (logoutEvent)="logout()"></app-header>

  <div class="content-container">
    <!-- Left sidebar with leagues -->
    <aside class="sidebar">
      <h2>{{ 'HOME.FEATURED_COMPETITIONS' | translate }}</h2>
      <div class="leagues-list">
        <div class="leagues-list">
          <div
            *ngFor="let sport of sports"
            class="league-item"
            [class.active]="selectedSportKey === sport.key"
            (click)="selectSport(sport.key)">
            <div class="league-info">
              <!-- Sport icon -->
              <span class="sport-icon">{{ getSportIcon(sport.key) }}</span>

              <!-- Country flag -->
              <img
                *ngIf="sport.country"
                class="league-flag"
                [src]="getCountryFlag(sport.country)"
                [alt]="sport.country"
                (error)="handleFlagError($event, sport.country)">

              <span class="league-name">{{ sport.title }}</span>
            </div>
            <span class="chevron">›</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main content with matches -->
    <main class="main-content">

      <!-- Contenido destacado - Solo visible cuando no hay deporte seleccionado Y el usuario no está logueado -->
      <div *ngIf="!selectedSportKey && !username" class="featured-content">
        <!-- Banner Antiludopatía -->
        <div class="antiludopatia-banner">
          <div class="banner-content">
            <div class="banner-header">
              <div class="banner-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div class="banner-title">
                <h3>{{ 'HOME.WARNING_SIGNS_TITLE' | translate }}</h3>
                <p>{{ 'HOME.CARE_MESSAGE' | translate }}</p>
              </div>
            </div>

            <div class="banner-question">
              <h4>{{ 'HOME.WARNING_SIGNS_TITLE' | translate }}</h4>
              <ul>
                <li>{{ 'HOME.WARNING_SIGN_1' | translate }}</li>
                <li>{{ 'HOME.WARNING_SIGN_2' | translate }}</li>
                <li>{{ 'HOME.WARNING_SIGN_3' | translate }}</li>
                <li>{{ 'HOME.WARNING_SIGN_4' | translate }}</li>
              </ul>
            </div>

            <div class="banner-initiatives">
              <h4>{{ 'HOME.PLATFORM_TITLE' | translate }}</h4>
              <p>{{ 'HOME.PLATFORM_DESCRIPTION' | translate }}</p>
              <ul>
                <li>{{ 'HOME.PLATFORM_FEATURE_1' | translate }}</li>
                <li>{{ 'HOME.PLATFORM_FEATURE_2' | translate }}</li>
                <li>{{ 'HOME.PLATFORM_FEATURE_3' | translate }}</li>
                <li>Entradas a eventos deportivos, culturales y actividades al aire libre</li>
                <li>{{ 'HOME.PLATFORM_FEATURE_4' | translate }}</li>
              </ul>
            </div>

            <!-- En la sección del banner, actualizar el enlace para que coincida con el ID correcto -->
            <div class="banner-actions">
              <a href="/responsible-gaming" class="banner-link">{{ 'HOME.GET_HELP_NOW' | translate }}</a>
              <a href="#premios-destacados" class="banner-link secondary" id="premios-link">{{ 'HOME.DISCOVER_PRIZES' | translate }}</a>
            </div>
          </div>
        </div>

        <!-- Carousel de Promociones -->
        <section class="promociones-carousel">
          <div class="carousel-container">
            <h2 class="carousel-title">{{ 'HOME.FEATURED_PROMOTIONS' | translate }}</h2>

            <div class="carousel-wrapper" *ngIf="promociones.length > 0">
              <div class="carousel-track" [style.transform]="'translateX(' + (-100 * currentPromocionIndex) + '%)'">
                <div class="promocion-slide" *ngFor="let promocion of promociones; let i = index">
                  <div class="promocion-card">
                    <!-- Update the promotion image in the carousel (around line 98) -->
                    <div class="promocion-image">
                      <img [src]="getPromocionImageUrl(promocion.image_url)" [alt]="promocion.title" (error)="handlePromocionImageError($event)">
                    </div>
                    <div class="promocion-content">
                      <span class="promocion-type">{{ promocion.type }}</span>
                      <h3 class="promocion-title">{{ promocion.title }}</h3>
                      <p class="promocion-description">{{ promocion.description }}</p>
                      <div class="promocion-footer">
                        <span class="promocion-date">Válido: {{ promocion.end_date | date:'dd/MM/yyyy' }}</span>
                        <button class="promocion-button" (click)="viewPromocion(promocion.id)">INSCRIBIRSE</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="carousel-controls" *ngIf="promociones.length > 1">
              <button class="carousel-button prev" (click)="prevPromocion()">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="carousel-indicators">
                <div
                  class="carousel-indicator"
                  *ngFor="let promocion of promociones; let i = index"
                  [class.active]="i === currentPromocionIndex"
                  (click)="goToPromocion(i)">
                </div>
              </div>
              <button class="carousel-button next" (click)="nextPromocion()">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- Premios Destacados section -->
        <section class="premios-carousel" id="premios-destacados">
          <div class="carousel-container">
            <h2 class="carousel-title">{{ 'HOME.FEATURED_PRIZES' | translate }}</h2>

            <div class="carousel-wrapper" *ngIf="premios.length > 0">
              <div class="carousel-track" [style.transform]="'translateX(' + (-100 * currentPremioIndex) + '%)'">
                <div class="premio-slide" *ngFor="let premio of premios; let i = index">
                  <div class="premio-card">
                    <!-- Update the prize image in the carousel (around line 135) -->
                    <div class="premio-image">
                      <img [src]="getPremioImageUrl(premio.image)" [alt]="premio.name" (error)="handlePremioImageError($event)">
                    </div>
                    <div class="premio-content">
                      <h3 class="premio-title">{{ premio.name }}</h3>
                      <p class="premio-description">{{ premio.description }}</p>
                      <div class="premio-footer">
                        <span class="premio-points">
                          {{ premio.points }}
                            <img src="assets/monedapnw.png" alt="Moneda" class="coin-icon">
                        </span>
                        <button class="premio-button" (click)="viewPremio(premio.id)">CANJEAR</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="carousel-controls" *ngIf="premios.length > 1">
              <button class="carousel-button prev" (click)="prevPremio()">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="carousel-indicators">
                <div
                  class="carousel-indicator"
                  *ngFor="let premio of premios; let i = index"
                  [class.active]="i === currentPremioIndex"
                  (click)="goToPremio(i)">
                </div>
              </div>
              <button class="carousel-button next" (click)="nextPremio()">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </section>
      </div>

      <!-- Título de deportes - Siempre visible -->
      <h1>{{ 'HOME.AVAILABLE_SPORTS' | translate }}</h1>

      <div *ngIf="error" class="alert alert-danger">
        {{ error }}
      </div>

      <div *ngIf="loading" class="alert alert-info">
        {{ 'HOME.LOADING_DATA' | translate }}
      </div>

      <!-- El resto del contenido permanece igual -->
      <!-- Partidos destacados - Solo se muestran cuando no hay liga seleccionada -->
      <div class="featured-matches" *ngIf="!selectedSportKey && featuredMatches.length > 0">
        <h3>{{ 'HOME.FEATURED_MATCHES' | translate }}</h3>

        <div class="matches-grid">
          @for (event of featuredMatches; track event.home_team) {
            <div class="match-card">
              <div class="match-header">
                <span class="match-league">{{ event.league || event.sport_title }}</span>
                <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>

              <div class="match-teams">
                <div class="team home-team">
                  <!-- For featured matches section -->
                  <div class="team-logo">
                    <img *ngIf="isTennisPlayer(event.home_team)"
                         [src]="getPlayerImage(event.home_team)"
                         alt="{{ event.home_team }}"
                         class="player-image"
                         (error)="handleTeamLogoError($event, event.home_team)">
                    <img *ngIf="!isTennisPlayer(event.home_team)"
                         [src]="getTeamLogo(event.home_team)"
                         alt="{{ event.home_team }}"
                         class="team-badge"
                         (error)="handleTeamLogoError($event, event.home_team)">
                  </div>
                  <div class="team-name">{{ event.home_team }}</div>
                </div>
                <div class="vs">VS</div>
                <div class="team away-team">
                  <div class="team-logo">
                    <!-- Fix: Add check for tennis player for away team -->
                    <img *ngIf="isTennisPlayer(event.away_team)"
                         [src]="getPlayerImage(event.away_team)"
                         alt="{{ event.away_team }}"
                         class="player-image"
                         (error)="handleTeamLogoError($event, event.away_team)">
                    <img *ngIf="!isTennisPlayer(event.away_team)"
                         [src]="getTeamLogo(event.away_team)"
                         alt="{{ event.away_team }}"
                         class="team-badge"
                         (error)="handleTeamLogoError($event, event.away_team)">
                  </div>
                  <div class="team-name">{{ event.away_team }}</div>
                </div>
              </div>

              <!-- Aplicando el nuevo diseño de cuotas a los partidos destacados -->
              <div class="match-odds-new">
                @if (event.bookmakers && event.bookmakers.length > 0 && event.bookmakers[0].markets && event.bookmakers[0].markets.length > 0) {
                  <div class="odds-container-new">
                    @for (outcome of getOrderedOutcomes(event.bookmakers[0].markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                      <div class="odd-column" [class.active]="isSelectionActive(event.id || '', outcome.name)">
                        <div class="odd-label-new">
                          {{ outcome.name === 'Draw' ? ('HOME.DRAW' | translate) : (outcome.name === event.home_team ? ('HOME.HOME' | translate) : ('HOME.AWAY' | translate)) }}
                        </div>
                                                <!-- Fix the button in the featured matches section -->
                        <button
                          class="odd-button-new"
                          [class.active]="isSelectionActive(event.id || '', outcome.name)"
                          (click)="openBetPopup(
                            outcome.name === 'Draw' ? 'Empate' : outcome.name,
                            event.bookmakers[0].markets[0].key,
                            outcome.price,
                            event.home_team,
                            event.away_team,
                            event.id || '',
                            event.league || event.sport_title
                          )"
                        >
                          {{ outcome.price }}
                        </button>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="no-odds-message">
                    {{ 'HOME.NO_ODDS_AVAILABLE' | translate }}
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Mensaje cuando no hay partidos seleccionados ni destacados -->
      <div class="welcome-message" *ngIf="!selectedSportKey && featuredMatches.length === 0">
        <h3>{{ 'HOME.WELCOME_TITLE' | translate }}</h3>
        <p>{{ 'HOME.WELCOME_TEXT' | translate }}</p>
      </div>

      <!-- Partidos de la liga seleccionada -->
      @if (selectedSportKey) {
        <div class="selected-league">
          <h3>{{ 'HOME.ODDS_FOR' | translate }} {{ getSelectedSportTitle() }}</h3>

          <div *ngIf="selectedSportKey && odds.length > 0" class="matches-container">
            <h2>{{ getSelectedSportTitle() }}</h2>

            <div class="matches-grid">
              @for (event of odds; track event.id) {
                <div class="match-card">
                  <div class="match-header">
                    <span class="match-league">{{ event.league || event.sport_title }}</span>
                    <span class="match-date">{{ event.commence_time | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>

                  <!-- Special handling for tennis matches -->
                  <div class="match-teams" [class.tennis-match]="selectedSportKey === 'tennis_atp_miami_open'">
                    <div class="team home-team">
                      <!-- For selected league section - home team -->
                      <div class="team-logo">
                        <img *ngIf="isTennisPlayer(event.home_team)"
                             [src]="getPlayerImage(event.home_team)"
                             alt="{{ event.home_team }}"
                             class="player-image"
                             (error)="handleTeamLogoError($event, event.home_team)">
                        <img *ngIf="!isTennisPlayer(event.home_team)"
                             [src]="getTeamLogo(event.home_team)"
                             alt="{{ event.home_team }}"
                             class="team-badge"
                             (error)="handleTeamLogoError($event, event.home_team)">
                      </div>
                      <div class="team-name">{{ event.home_team }}</div>
                    </div>
                    <div class="vs">{{ 'HOME.VS' | translate }}</div>
                    <div class="team away-team">
                      <!-- For selected league section - away team -->
                      <div class="team-logo">
                        <img *ngIf="isTennisPlayer(event.away_team)"
                             [src]="getPlayerImage(event.away_team)"
                             alt="{{ event.away_team }}"
                             class="player-image"
                             (error)="handleTeamLogoError($event, event.away_team)">
                        <img *ngIf="!isTennisPlayer(event.away_team)"
                             [src]="getTeamLogo(event.away_team)"
                             alt="{{ event.away_team }}"
                             class="team-badge"
                             (error)="handleTeamLogoError($event, event.away_team)">
                      </div>
                      <div class="team-name">{{ event.away_team }}</div>
                    </div>
                  </div>

                  <!-- Nueva sección de cuotas mejorada -->
                  <div class="match-odds-new">
                    @if (event.bookmakers && event.bookmakers.length > 0 && event.bookmakers[0].markets && event.bookmakers[0].markets.length > 0) {
                      <div class="odds-container-new">
                        @for (outcome of getOrderedOutcomes(event.bookmakers[0].markets[0].outcomes, event.home_team, event.away_team); track outcome.name) {
                          <div class="odd-column">
                            <div class="odd-label-new">
                              {{ outcome.name === 'Draw' ? ('HOME.DRAW' | translate) : (outcome.name === event.home_team ? ('HOME.HOME' | translate) : ('HOME.AWAY' | translate)) }}
                            </div>
                                                        <!-- Fix the button in the selected league section -->
                            <button
                              class="odd-button-new"
                              [class.active]="isSelectionActive(event.id || '', outcome.name)"
                              (click)="openBetPopup(
                                outcome.name === 'Draw' ? 'Empate' : outcome.name,
                                event.bookmakers[0].markets[0].key,
                                outcome.price,
                                event.home_team,
                                event.away_team,
                                event.id || '',
                                event.league || event.sport_title
                              )"
                            >
                              {{ outcome.price }}
                            </button>
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="no-odds-message">
                        {{ 'HOME.NO_ODDS_AVAILABLE' | translate }}
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </main>
  </div>
</div>

<!-- Componente de pop-up de apuesta -->
<app-bet-popup
  [visible]="showBetPopup"
  [teamName]="selectedBet.teamName"
  [betType]="selectedBet.betType"
  [odds]="selectedBet.odds"
  [matchInfo]="selectedBet.matchInfo"
  (close)="closeBetPopup()"
  (placeBet)="placeBet($event)"
></app-bet-popup>

<!-- Añadir el componente de apuesta combinada al final -->
<app-combined-bet></app-combined-bet>

<!-- Update your ngFor to use the new tracking function -->
<div *ngFor="let match of featuredMatches; trackBy: trackByMatch">
  <!-- match content -->
</div>

<!-- Update the competitions list section -->
<div class="competitions-list">
  @for (sport of sports; track sport.key) {
    <div 
      class="competition-item" 
      [class.active]="selectedSportKey === sport.key"
      (click)="loadOdds(sport.key)">
      <div class="competition-icon">
        <i class="fas fa-futbol" *ngIf="sport.key.includes('soccer')"></i>
        <i class="fas fa-basketball-ball" *ngIf="sport.key.includes('basketball')"></i>
        <i class="fas fa-baseball-ball" *ngIf="sport.key.includes('baseball')"></i>
        <i class="fas fa-table-tennis" *ngIf="sport.key.includes('tennis')"></i>
      </div>
      <span class="competition-name">{{ sport.title }}</span>
    </div>
  }
</div>