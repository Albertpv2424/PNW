<!-- Background div -->
<div class="background-container"></div>

<div class="profile-container">
  <!-- Reemplazar el header actual con el componente compartido -->
  <app-profile-header [username]="username" [email]="email" [profileImage]="profileImage" [saldo]="saldo"
    [activeTab]="editMode ? 'edit' : 'profile'"></app-profile-header>

  <!-- Eliminar la navegaci√≥n existente ya que ahora est√° en el componente compartido -->

  <div class="profile-content">
    <!-- Vista de perfil normal -->
    <ng-container *ngIf="!editMode">
      <div class="profile-section">
        <h2>{{ 'PROFILE.PERSONAL_INFO' | translate }}</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">DNI/NIE:</span>
            <span class="info-value">{{ dni }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'PROFILE.PHONE' | translate }}:</span>
            <span class="info-value">{{ telefon || ('PROFILE.NOT_SPECIFIED' | translate) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'PROFILE.BIRTH_DATE' | translate }}:</span>
            <span class="info-value">{{ dataNaixement | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h2>{{ 'PROFILE.ACTIVITY_SUMMARY' | translate }}</h2>
        <div class="activity-summary">
          <div class="activity-card">
            <div class="activity-icon">üéÆ</div>
            <div class="activity-count">{{ stats.pendingBets }}</div>
            <div class="activity-label">{{ 'BETS.ACTIVE_BETS' | translate }}</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">‚úÖ</div>
            <div class="activity-count">{{ stats.wonBets }}</div>
            <div class="activity-label">{{ 'PROFILE.WON_BETS' | translate }}</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">‚ùå</div>
            <div class="activity-count">{{ stats.lostBets }}</div>
            <div class="activity-label">{{ 'PROFILE.LOST_BETS' | translate }}</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üí∞</div>
            <div class="activity-count">{{ stats.totalWinnings | number:'1.0-0' }}</div>
            <div class="activity-label">{{ 'PROFILE.TOTAL_WINNINGS' | translate }}</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üìä</div>
            <div class="activity-count">{{ stats.winRate | number:'1.1-1' }}%</div>
            <div class="activity-label">{{ 'PROFILE.WIN_RATE' | translate }}</div>
          </div>
        </div>
      </div>

      <!-- Add this section to your profile component template -->
      <div class="profile-section">
        <h3>{{ 'PRIZES.REDEEMED_PRIZES' | translate }}</h3>

        @if (loadingPrizes) {
        <div class="loading-spinner">{{ 'COMMON.LOADING' | translate }}</div>
        } @else if (prizesError) {
        <div class="error-message">{{ prizesError }}</div>
        } @else if (redeemedPrizes.length === 0) {
        <div class="empty-message">{{ 'PRIZES.NO_REDEEMED_PRIZES' | translate }}</div>
        } @else {
        <div class="prizes-grid">
          @for (prize of redeemedPrizes; track prize.id) {
          <div class="prize-card">
            <div class="prize-image">
              <img [src]="prize.image ? 'http://localhost:8000/' + prize.image : 'assets/premios/default.png'"
                [alt]="prize.titulo">
            </div>
            <div class="prize-info">
              <h4>{{ prize.titulo }}</h4>
              <p *ngIf="prize.descripcion" class="description">{{ prize.descripcion }}</p>
              <div class="prize-details">
                <p class="prize-date">{{ 'PRIZES.REDEEMED' | translate }}: {{ prize.fecha_canje | date:'dd/MM/yyyy' }}
                </p>
                <p class="prize-date">{{ 'PRIZES.VALID_UNTIL' | translate }}: {{ prize.fecha_limite | date:'dd/MM/yyyy'
                  }}</p>
                <p class="prize-status" [class.used]="prize.usado">
                  {{ prize.usado ? ('PRIZES.USED' | translate) : ('PRIZES.AVAILABLE' | translate) }}
                </p>
              </div>
            </div>
          </div>
          }
        </div>
        }
      </div>
      <div class="profile-section">
        <h2>{{ 'BETS.RECENT_BETS' | translate }}</h2>
        <div class="recent-bets">
          <div class="loading-spinner" *ngIf="loadingRecentBets">
            <div class="spinner"></div>
            <p>{{ 'BETS.LOADING_BETS' | translate }}</p>
          </div>

          <div class="empty-state" *ngIf="!loadingRecentBets && recentBets.length === 0">
            <div class="empty-icon">üìä</div>
            <p>{{ 'BETS.NO_RECENT_BETS' | translate }}</p>
            <a routerLink="/" class="action-button">{{ 'BETS.PLACE_BET' | translate }}</a>
          </div>

          <div class="bets-list" *ngIf="!loadingRecentBets && recentBets.length > 0">
            <div class="bet-card" *ngFor="let bet of recentBets" [ngClass]="{
                   'won': bet.status.toLowerCase() === 'ganada',
                   'lost': bet.status.toLowerCase() === 'perdida'
                 }">
              <div class="bet-header">
                <span class="bet-date">{{ formatDate(bet.created_at) }}</span>
                <span class="bet-status" [ngClass]="getStatusClass(bet.status)">{{ getTranslatedStatus(bet.status)
                  }}</span>
              </div>

              <div class="bet-details">
                <h3 class="bet-match">{{ bet.match_info }}</h3>
                <p class="bet-selection">
                  <strong>{{ 'BETS.SELECTION' | translate }}:</strong> {{ bet.prediction_choice }}
                </p>
                <div class="bet-info">
                  <div class="bet-amount">
                    <span>{{ 'BETS.BET_AMOUNT' | translate }}:</span>
                    <strong>{{ bet.punts_proposats }} <img src="assets/monedapnw.png" alt="Moneda"
                        class="coin-icon"></strong>
                  </div>
                  <div class="bet-odds">
                    <span>{{ 'BETS.ODDS' | translate }}:</span>
                    <strong>{{ bet.cuota }}</strong>
                  </div>
                  <div class="bet-result" *ngIf="bet.status.toLowerCase() === 'ganada'">
                    <span>{{ 'BETS.WINNINGS' | translate }}:</span>
                    <strong>{{ bet.punts_proposats * bet.cuota | number:'1.0-0' }} <img src="assets/monedapnw.png"
                        alt="Moneda" class="coin-icon"></strong>
                  </div>
                </div>
              </div>
            </div>

            <div class="view-all-bets">
              <a routerLink="/profile/bets" class="view-all-link">{{ 'BETS.VIEW_ALL_BETS' | translate }}</a>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Vista de edici√≥n de perfil mejorada -->
    <ng-container *ngIf="editMode">
      <div class="profile-section">
        <h2>{{ 'PROFILE.EDIT_PROFILE' | translate }}</h2>
        <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="edit-form">
          <div class="profile-image-section">
            <h3>{{ 'PROFILE.PHOTO' | translate }}</h3>
            <div class="image-preview-container">
              <div class="image-preview"
                [style.background-image]="imagePreview ? 'url(' + imagePreview + ')' : (profileImage ? 'url(http://localhost:8000/' + profileImage + ')' : 'none')">
                <span *ngIf="!imagePreview && !profileImage">{{ getInitials() }}</span>
              </div>
              <div class="image-upload">
                <input type="file" id="profile-image" (change)="onImageSelected($event)" accept="image/*"
                  class="file-input">
                <label for="profile-image" class="file-label">{{ 'PROFILE.CHANGE_IMAGE' | translate }}</label>
                <p *ngIf="selectedFile" class="selected-file-name">{{ selectedFile.name }}</p>
              </div>
            </div>
          </div>

          <!-- Update the form labels and buttons to use translations -->
          <div class="form-group">
            <label for="nick">{{ 'PROFILE.USERNAME' | translate }}</label>
            <input type="text" id="nick" formControlName="nick" class="form-control">
            <div class="form-error" *ngIf="profileForm.get('nick')?.invalid && profileForm.get('nick')?.touched">
              {{ 'ERRORS.REQUIRED' | translate }}
            </div>
          </div>

          <div class="form-group">
            <label for="email">{{ 'PROFILE.EMAIL' | translate }}</label>
            <input type="email" id="email" formControlName="email" class="form-control">
            <div class="form-error" *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
              <span *ngIf="profileForm.get('email')?.errors?.['required']">{{ 'ERRORS.REQUIRED' | translate }}</span>
              <span *ngIf="profileForm.get('email')?.errors?.['email']">{{ 'ERRORS.EMAIL_INVALID' | translate }}</span>
            </div>
          </div>

          <div class="form-group">
            <label for="telefon">{{ 'PROFILE.PHONE' | translate }}</label>
            <input type="tel" id="telefon" formControlName="telefon" class="form-control">
          </div>

          <!-- Update password section -->
          <div class="password-section">
            <h3>{{ 'PROFILE.CHANGE_PASSWORD' | translate }}</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="current_password">{{ 'PROFILE.CURRENT_PASSWORD' | translate }}</label>
                <input type="password" id="current_password" formControlName="current_password" class="form-control">
              </div>

              <div class="form-group">
                <label for="new_password">{{ 'PROFILE.NEW_PASSWORD' | translate }}</label>
                <input type="password" id="new_password" formControlName="new_password" class="form-control">
              </div>
            </div>
          </div>

          <!-- Update buttons -->
          <div class="form-actions">
            <button type="submit" class="save-button">{{ 'PROFILE.SAVE_CHANGES' | translate }}</button>
          </div>
        </form>

        <!-- Secci√≥n para borrar cuenta -->
        <div class="delete-account-section">
          <h3>{{ 'PROFILE.DELETE_ACCOUNT' | translate }}</h3>
          <p class="warning-text">{{ 'PROFILE.DELETE_WARNING' | translate }}</p>
          <button class="delete-button" (click)="showDeleteConfirmation()">{{ 'PROFILE.DELETE_MY_ACCOUNT' | translate
            }}</button>
        </div>
      </div>
    </ng-container>

    <!-- Modal de confirmaci√≥n para borrar cuenta -->
    <div class="confirmation-modal" *ngIf="showDeleteModal">
      <div class="modal-content">
        <h3>{{ 'PROFILE.ARE_YOU_SURE' | translate }}</h3>
        <p>{{ 'PROFILE.DELETE_CONFIRMATION_TEXT' | translate }}</p>

        <div class="confirmation-input">
          <label for="confirm-delete">{{ 'PROFILE.TYPE_DELETE' | translate }}</label>
          <input type="text" id="confirm-delete" [(ngModel)]="deleteConfirmText">
        </div>

        <div class="modal-actions">
          <button class="cancel-button" (click)="cancelDelete()">{{ 'COMMON.CANCEL' | translate }}</button>
          <button class="confirm-button" [disabled]="deleteConfirmText !== 'ELIMINAR'" (click)="deleteAccount()">
            {{ 'PROFILE.CONFIRM_DELETION' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>