<!-- Background div -->
<div class="background-container"></div>

<div class="profile-container">
  <div class="profile-header">
    <div class="profile-avatar">
      <div class="profile-image" [style.background-image]="profileImage ? 'url(http://localhost:8000/' + profileImage + ')' : 'none'">
        <span *ngIf="!profileImage">{{ getInitials() }}</span>
      </div>
    </div>
    <div class="profile-info">
      <h1>{{ username }}</h1>
      <p class="profile-email">{{ email }}</p>
      <!-- Reemplaza la secci√≥n del saldo con este c√≥digo -->
      <div class="profile-balance">
        <div class="balance-icon">
          <img src="assets/monedapnw.png" alt="Moneda">
        </div>
        <span class="balance-amount">
          <span class="integer-part">{{ saldo | number:'1.0-0' }}</span>
          <span class="decimal-part">.{{ (saldo.toString().split('.')[1] || '00').padEnd(2, '0') }}</span>
        </span>
      </div>
    </div>
    <!-- Bot√≥n para volver al home -->
    <a routerLink="/" class="home-button">
      <span class="home-icon">üè†</span>
      <span>Volver al inicio</span>
    </a>
  </div>

  <!-- Update the navigation section -->
  <div class="profile-navigation">
    <a routerLink="/profile" class="nav-item" [class.active]="!editMode && !isBetsView && !isHistoryView">Perfil</a>
    <a routerLink="/profile/bets" class="nav-item" [class.active]="isBetsView">Mis Apuestas</a>
    <a routerLink="/profile/history" class="nav-item" [class.active]="isHistoryView">Historial</a>
    <a routerLink="/profile/edit" class="nav-item" [class.active]="editMode">Editar Perfil</a>
  </div>

  <div class="profile-content">
    <!-- Vista de perfil normal -->
    <ng-container *ngIf="!editMode">
      <div class="profile-section">
        <h2>Informaci√≥n Personal</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">DNI/NIE:</span>
            <span class="info-value">{{ dni }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Tel√©fono:</span>
            <span class="info-value">{{ telefon || 'No especificado' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Fecha de Nacimiento:</span>
            <span class="info-value">{{ dataNaixement | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h2>Resumen de Actividad</h2>
        <div class="activity-summary">
          <div class="activity-card">
            <div class="activity-icon">üéÆ</div>
            <div class="activity-count">{{ stats.pendingBets }}</div>
            <div class="activity-label">Apuestas Activas</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">‚úÖ</div>
            <div class="activity-count">{{ stats.wonBets }}</div>
            <div class="activity-label">Apuestas Ganadas</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">‚ùå</div>
            <div class="activity-count">{{ stats.lostBets }}</div>
            <div class="activity-label">Apuestas Perdidas</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üí∞</div>
            <div class="activity-count">{{ stats.totalWinnings | number:'1.0-0' }}</div>
            <div class="activity-label">Ganancias Totales</div>
          </div>
          <div class="activity-card">
            <div class="activity-icon">üìä</div>
            <div class="activity-count">{{ stats.winRate | number:'1.1-1' }}%</div>
            <div class="activity-label">% de Victoria</div>
          </div>
        </div>
      </div>

      <!-- Add this section to your profile component template -->
      <div class="profile-section">
        <h3>Premios Canjeados</h3>

        @if (loadingPrizes) {
          <div class="loading-spinner">Cargando premios...</div>
        } @else if (prizesError) {
          <div class="error-message">{{ prizesError }}</div>
        } @else if (redeemedPrizes.length === 0) {
          <div class="empty-message">No has canjeado ning√∫n premio todav√≠a.</div>
        } @else {
          <div class="prizes-grid">
            @for (prize of redeemedPrizes; track prize.id) {
              <div class="prize-card">
                <div class="prize-image">
                  <img [src]="prize.image ? 'http://localhost:8000/' + prize.image : 'assets/premios/default.png'" [alt]="prize.titulo">
                </div>
                <div class="prize-info">
                  <h4>{{ prize.titulo }}</h4>
                  <p *ngIf="prize.descripcion" class="description">{{ prize.descripcion }}</p>
                  <div class="prize-details">
                    <p class="prize-date">Canjeado: {{ prize.fecha_canje | date:'dd/MM/yyyy' }}</p>
                    <p class="prize-date">V√°lido hasta: {{ prize.fecha_limite | date:'dd/MM/yyyy' }}</p>
                    <p class="prize-status" [class.used]="prize.usado">
                      {{ prize.usado ? 'Usado' : 'Disponible' }}
                    </p>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
      <div class="profile-section">
        <h2>√öltimas Apuestas</h2>
        <div class="recent-bets">
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <p>No tienes apuestas recientes</p>
            <a routerLink="/" class="action-button">Realizar una apuesta</a>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Vista de edici√≥n de perfil mejorada -->
    <ng-container *ngIf="editMode">
      <div class="profile-section">
        <h2>Editar Perfil</h2>
        <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="edit-form">
          <div class="profile-image-section">
            <h3>Foto de perfil</h3>
            <div class="image-preview-container">
              <div class="image-preview" [style.background-image]="imagePreview ? 'url(' + imagePreview + ')' : (profileImage ? 'url(http://localhost:8000/' + profileImage + ')' : 'none')">
                <span *ngIf="!imagePreview && !profileImage">{{ getInitials() }}</span>
              </div>
              <div class="image-upload">
                <input type="file" id="profile-image" (change)="onImageSelected($event)" accept="image/*" class="file-input">
                <label for="profile-image" class="file-label">Cambiar imagen</label>
                <p *ngIf="selectedFile" class="selected-file-name">{{ selectedFile.name }}</p>
              </div>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="nick">Nombre de usuario</label>
              <input type="text" id="nick" formControlName="nick" class="form-control">
              <div class="form-error" *ngIf="profileForm.get('nick')?.invalid && profileForm.get('nick')?.touched">
                El nombre de usuario es obligatorio
              </div>
            </div>

            <div class="form-group">
              <label for="email">Correo electr√≥nico</label>
              <input type="email" id="email" formControlName="email" class="form-control">
              <div class="form-error" *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
                Introduce un correo electr√≥nico v√°lido
              </div>
            </div>

            <div class="form-group">
              <label for="telefon">Tel√©fono</label>
              <input type="tel" id="telefon" formControlName="telefon" class="form-control">
            </div>
          </div>

          <div class="password-section">
            <h3>Cambiar contrase√±a</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="current_password">Contrase√±a actual</label>
                <input type="password" id="current_password" formControlName="current_password" class="form-control">
              </div>

              <div class="form-group">
                <label for="new_password">Nueva contrase√±a</label>
                <input type="password" id="new_password" formControlName="new_password" class="form-control">
                <div class="form-error" *ngIf="profileForm.get('new_password')?.value && profileForm.get('new_password')?.value.length < 8">
                  La contrase√±a debe tener al menos 8 caracteres
                </div>
              </div>

              <div class="form-group">
                <label for="confirm_password">Confirmar nueva contrase√±a</label>
                <input type="password" id="confirm_password" formControlName="confirm_password" class="form-control">
                <div class="form-error" *ngIf="profileForm.get('new_password')?.value !== profileForm.get('confirm_password')?.value && profileForm.get('confirm_password')?.value">
                  Las contrase√±as no coinciden
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="save-button" [disabled]="profileForm.invalid">Guardar cambios</button>
          </div>
        </form>

        <!-- Secci√≥n para borrar cuenta -->
        <div class="delete-account-section">
          <h3>Eliminar cuenta</h3>
          <p class="warning-text">Esta acci√≥n es irreversible. Todos tus datos ser√°n eliminados permanentemente.</p>
          <button class="delete-button" (click)="showDeleteConfirmation()">Eliminar mi cuenta</button>
        </div>
      </div>
    </ng-container>

    <!-- Modal de confirmaci√≥n para borrar cuenta -->
    <div class="confirmation-modal" *ngIf="showDeleteModal">
      <div class="modal-content">
        <h3>¬øEst√°s seguro?</h3>
        <p>Esta acci√≥n eliminar√° permanentemente tu cuenta y todos tus datos asociados. No podr√°s recuperarlos.</p>

        <div class="confirmation-input">
          <label for="confirm-delete">Para confirmar, escribe "ELIMINAR"</label>
          <input type="text" id="confirm-delete" [(ngModel)]="deleteConfirmText">
        </div>

        <div class="modal-actions">
          <button class="cancel-button" (click)="cancelDelete()">Cancelar</button>
          <button class="confirm-button" [disabled]="deleteConfirmText !== 'ELIMINAR'" (click)="deleteAccount()">
            Confirmar eliminaci√≥n
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
