<div class="admin-dashboard">
  <div class="dashboard-content">
    <main class="main-content">
      <div class="users-header">
        <h2>Usuarios Registrados</h2>
        <div class="actions">
          <div class="search-container">
            <input 
              type="text" 
              placeholder="Buscar usuario..." 
              [(ngModel)]="searchTerm"
              (input)="searchUsers()"
            >
          </div>
          <button class="add-user-btn" (click)="openUserForm()">Añadir Usuario</button>
        </div>
      </div>

      <div class="users-table-container" *ngIf="!isLoading; else loadingTemplate">
        <table class="users-table" *ngIf="filteredUsers.length > 0; else noUsersTemplate">
          <thead>
            <tr>
              <th>Nick</th>
              <th>Email</th>
              <th>DNI</th>
              <th>Teléfono</th>
              <th>Fecha Nacimiento</th>
              <th>Tipo</th>
              <th>Saldo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers">
              <td>
                <div class="user-cell">
                  <div class="user-avatar" 
                       [style.background-image]="user.profile_image ? (user.profile_image.startsWith('http') ? 'url(' + user.profile_image + ')' : 'url(http://localhost:8000/' + user.profile_image + ')') : 'none'">
                    <span *ngIf="!user.profile_image">{{ getUserInitials(user.nick) }}</span>
                  </div>
                  {{ user.nick }}
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>{{ user.dni }}</td>
              <td>{{ user.telefon || 'N/A' }}</td>
              <td>{{ formatDate(user.data_naixement) }}</td>
              <td>{{ user.tipus_acc }}</td>
              <td>
                {{ user.saldo | number:'1.0-0' }}
                <img src="assets/monedapnw.png" alt="Moneda PNW" class="coin-icon">
              </td>
              <td class="actions-cell">
                <button class="action-btn edit-btn" (click)="openUserForm(user)">Editar</button>
                <button class="action-btn balance-btn" (click)="openBalanceForm(user)">Saldo</button>
                <button class="action-btn delete-btn" (click)="confirmDeleteUser(user.id)">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
        
        <ng-template #noUsersTemplate>
          <div class="no-users">
            <p>No se encontraron usuarios.</p>
          </div>
        </ng-template>
      </div>
      
      <ng-template #loadingTemplate>
        <div class="loading">
          <p>Cargando usuarios...</p>
        </div>
      </ng-template>
    </main>
  </div>
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal" *ngIf="showUserForm">
  <div class="modal-content">
    <div class="modal-header">
      <h2>{{ isEditing ? 'Editar Usuario' : 'Crear Usuario' }}</h2>
      <button class="close-btn" (click)="closeUserForm()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="userForm" (ngSubmit)="submitUserForm()">
        <!-- Add profile image preview at the top of the form -->
        <div class="form-group profile-image-group">
          <label>Imagen de perfil:</label>
          <div class="profile-preview">
            <div class="user-avatar large-avatar" 
                 [style.background-image]="selectedUser && selectedUser.profile_image ? (selectedUser.profile_image.startsWith('http') ? 'url(' + selectedUser.profile_image + ')' : 'url(http://localhost:8000/' + selectedUser.profile_image + ')') : 'none'">
              <span *ngIf="!selectedUser || !selectedUser.profile_image">{{ selectedUser ? getUserInitials(selectedUser.nick) : '' }}</span>
            </div>
          </div>
        </div>
        
        <!-- Continue with the rest of the form fields -->
        <div class="form-group">
          <label for="nick">Nick:</label>
          <input type="text" id="nick" formControlName="nick">
          <div class="error" *ngIf="userForm.get('nick')?.invalid && userForm.get('nick')?.touched">
            El nick es requerido
          </div>
        </div>
        
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" formControlName="email">
          <div class="error" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
            Email inválido
          </div>
        </div>
        
        <div class="form-group">
          <label for="password">{{ isEditing ? 'Contraseña (dejar en blanco para mantener)' : 'Contraseña:' }}</label>
          <input type="password" id="password" formControlName="password">
          <div class="error" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
            La contraseña es requerida
          </div>
        </div>
        
        <div class="form-group">
          <label for="dni">DNI:</label>
          <input type="text" id="dni" formControlName="dni">
          <div class="error" *ngIf="userForm.get('dni')?.invalid && userForm.get('dni')?.touched">
            El DNI es requerido
          </div>
        </div>
        
        <div class="form-group">
          <label for="telefon">Teléfono:</label>
          <input type="text" id="telefon" formControlName="telefon">
        </div>
        
        <div class="form-group">
          <label for="data_naixement">Fecha de nacimiento:</label>
          <input type="date" id="data_naixement" formControlName="data_naixement">
          <div class="error" *ngIf="userForm.get('data_naixement')?.invalid && userForm.get('data_naixement')?.touched">
            La fecha de nacimiento es requerida
          </div>
        </div>
        
        <div class="form-group">
          <label for="saldo">Saldo:</label>
          <input type="number" id="saldo" formControlName="saldo" min="0">
          <div class="error" *ngIf="userForm.get('saldo')?.invalid && userForm.get('saldo')?.touched">
            El saldo debe ser un número positivo
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="closeUserForm()">Cancelar</button>
          <button type="submit" class="submit-btn" [disabled]="userForm.invalid">
            {{ isEditing ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para actualizar saldo -->
<div class="modal" *ngIf="showBalanceForm">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Actualizar Saldo</h2>
      <button class="close-btn" (click)="closeBalanceForm()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Usuario: <strong>{{ selectedUser?.nick }}</strong></p>
      <p>Saldo actual: <strong>{{ selectedUser?.saldo }}</strong></p>
      
      <form [formGroup]="balanceForm" (ngSubmit)="submitBalanceForm()">
        <div class="form-group">
          <label for="amount">Nuevo saldo:</label>
          <input type="number" id="amount" formControlName="amount" min="0">
          <div class="error" *ngIf="balanceForm.get('amount')?.invalid && balanceForm.get('amount')?.touched">
            El saldo debe ser un número positivo
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="closeBalanceForm()">Cancelar</button>
          <button type="submit" class="submit-btn" [disabled]="balanceForm.invalid">Actualizar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar usuario -->
<div class="modal" *ngIf="showDeleteConfirm">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Confirmar Eliminación</h2>
      <button class="close-btn" (click)="cancelDeleteUser()">&times;</button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.</p>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="cancelDeleteUser()">Cancelar</button>
        <button type="button" class="delete-btn" (click)="deleteUser()">Eliminar</button>
      </div>
    </div>
  </div>
</div>