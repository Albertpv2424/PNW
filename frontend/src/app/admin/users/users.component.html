<div class="admin-container">
  <div class="component-header">
    <h2>Usuarios Registrados</h2>
    <div class="actions">
      <div class="search-container">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="searchUsers()"
          placeholder="Buscar usuarios..."
        >
        <i class="fas fa-search search-icon"></i>
      </div>
      <button class="primary-btn" (click)="openUserForm()">
        <i class="fas fa-plus"></i> Nuevo Usuario
      </button>
    </div>
  </div>

  <div class="loading" *ngIf="isLoading">
    Cargando usuarios...
  </div>

  <div class="no-data" *ngIf="!isLoading && filteredUsers.length === 0">
    No hay usuarios disponibles. Crea un nuevo usuario para comenzar.
  </div>

  <div class="table-container" *ngIf="!isLoading && filteredUsers.length > 0">
    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Email</th>
          <th>DNI</th>
          <th>Teléfono</th>
          <th>Tipo</th>
          <th>Saldo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td class="id-cell">{{ user.id }}</td>
          <td>
            <div class="user-cell">
              <div class="user-avatar"
                   [style.background-image]="user.profile_image ? (user.profile_image.startsWith('http') ? 'url(' + user.profile_image + ')' : 'url(http://localhost:8000/' + user.profile_image + ')') : 'none'">
                <span *ngIf="!user.profile_image">{{ getUserInitials(user.nick) }}</span>
              </div>
              {{ user.nick }}
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>{{ user.dni }}</td>
          <td>{{ user.telefon || 'N/A' }}</td>
          <td>
            <span class="type-badge" [ngClass]="'type-' + (user.tipus_acc === 'Usuario' ? '1' : '2')">
              {{ user.tipus_acc }}
            </span>
          </td>
          <td class="points-cell">
            {{ user.saldo | number:'1.0-0' }}
            <img src="assets/monedapnw.png" alt="Moneda PNW" class="coin-icon">
          </td>
          <td>
            <div class="action-buttons">
              <button class="action-btn edit-btn" (click)="openUserForm(user)" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn balance-btn" (click)="openBalanceForm(user)" title="Saldo">
                <i class="fas fa-coins"></i>
              </button>
              <!-- Make sure your delete button looks like this -->
              <button class="action-btn delete-btn" (click)="confirmDeleteUser(user)" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- User Form Modal -->
  <div class="modal" *ngIf="showUserForm">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ isEditing ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</h3>
        <button class="close-btn" (click)="closeUserForm()">×</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="userForm" (ngSubmit)="submitUserForm()">
          <div class="form-group">
            <label for="nick">Nombre de Usuario</label>
            <input type="text" id="nick" formControlName="nick" [readonly]="isEditing">
            <div class="error-message" *ngIf="userForm.get('nick')?.invalid && userForm.get('nick')?.touched">
              El nombre de usuario es obligatorio
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" formControlName="email">
            <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
              Introduce un email válido
            </div>
          </div>

          <div class="form-group">
            <label for="password">Contraseña {{ isEditing ? '(dejar en blanco para mantener la actual)' : '' }}</label>
            <input type="password" id="password" formControlName="password">
            <div class="error-message" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
              La contraseña es obligatoria
            </div>
          </div>

          <div class="form-group">
            <label for="dni">DNI</label>
            <input type="text" id="dni" formControlName="dni">
            <div class="error-message" *ngIf="userForm.get('dni')?.invalid && userForm.get('dni')?.touched">
              El DNI es obligatorio
            </div>
          </div>

          <div class="form-group">
            <label for="telefon">Teléfono</label>
            <input type="text" id="telefon" formControlName="telefon">
          </div>

          <div class="form-group">
            <label for="data_naixement">Fecha de Nacimiento</label>
            <input type="date" id="data_naixement" formControlName="data_naixement">
            <div class="error-message" *ngIf="userForm.get('data_naixement')?.invalid && userForm.get('data_naixement')?.touched">
              La fecha de nacimiento es obligatoria
            </div>
          </div>

          <div class="form-group">
            <label for="saldo">Saldo Inicial</label>
            <input type="number" id="saldo" formControlName="saldo" min="0">
            <div class="error-message" *ngIf="userForm.get('saldo')?.invalid && userForm.get('saldo')?.touched">
              El saldo debe ser un número positivo
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="secondary-btn" (click)="closeUserForm()">Cancelar</button>
            <button type="submit" class="primary-btn" [disabled]="userForm.invalid">
              {{ isEditing ? 'Actualizar' : 'Crear' }} Usuario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para actualizar saldo -->
<div class="modal" *ngIf="showBalanceForm">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Actualizar Saldo</h2>
      <button class="close-btn" (click)="closeBalanceForm()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Usuario: <strong>{{ selectedUser?.nick }}</strong></p>
      <p>Saldo actual: <strong>{{ selectedUser?.saldo }}</strong></p>

      <form [formGroup]="balanceForm" (ngSubmit)="submitBalanceForm()">
        <div class="form-group">
          <label for="amount">Nuevo saldo:</label>
          <input type="number" id="amount" formControlName="amount" min="0">
          <div class="error" *ngIf="balanceForm.get('amount')?.invalid && balanceForm.get('amount')?.touched">
            El saldo debe ser un número positivo
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="closeBalanceForm()">Cancelar</button>
          <button type="submit" class="submit-btn" [disabled]="balanceForm.invalid">Actualizar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar usuario -->
<div class="modal" *ngIf="showDeleteConfirm">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Confirmar Eliminación Completa</h2>
      <button class="close-btn" (click)="cancelDeleteUser()">&times;</button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas eliminar al usuario <strong>{{ selectedUser?.nick }}</strong>?</p>
      <p>Esta acción eliminará:</p>
      <ul>
        <li>Todos los mensajes de chat del usuario</li>
        <li>Todas las apuestas realizadas</li>
        <li>Todas las sesiones de chat</li>
        <li>Todos los registros de actividad</li>
        <li>La imagen de perfil del usuario</li>
        <li>La cuenta del usuario</li>
      </ul>
      <p><strong>Esta acción no se puede deshacer.</strong></p>

      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="cancelDeleteUser()">Cancelar</button>
        <button type="button" class="delete-btn" (click)="deleteUser()">Eliminar Todo</button>
      </div>
    </div>
  </div>
</div>