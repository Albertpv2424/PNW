<div class="limitations-container">
  <div class="limitations-header">
    <h1 class="page-title">Gestión de Restricciones de Usuario</h1>
    
    <button class="btn-primary global-limits-btn" (click)="openGlobalLimitationsModal()">
      <i class="fas fa-globe"></i> Establecer límites globales
    </button>
  </div>

  <div class="search-card">
    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        (input)="filterUsers()" 
        placeholder="Buscar usuario..."
        class="search-input"
      >
    </div>
  </div>

  <div class="limitations-content">
    <div class="users-list-container">
      <h2 class="section-title">Lista de Usuarios y sus Restricciones</h2>
      
      <div *ngIf="loading" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando usuarios...</p>
      </div>
      
      <div *ngIf="!loading && filteredUsers.length === 0" class="no-results">
        <i class="fas fa-search fa-3x"></i>
        <p>No se encontraron usuarios con los criterios de búsqueda</p>
      </div>
      
      <div *ngIf="!loading && filteredUsers.length > 0" class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Apuestas Hoy</th>
              <th>Tiempo Hoy</th>
              <th>Restricciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers" 
                [class.selected]="selectedUser && selectedUser.username === user.username"
                (click)="selectUser(user)">
              <td class="username-cell">{{ user.username }}</td>
              <td class="bets-cell">{{ user.bets_today }} / {{ user.max_daily_bets }}</td>
              <td class="time-cell">{{ formatTime(user.betting_time_today) }} / {{ formatTime(user.max_daily_betting_time) }}</td>
              <td class="restrictions-cell">
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="isLimitationsEnabled(user)" 
                    (change)="toggleLimitations(user, $event)"
                    (click)="$event.stopPropagation()"
                  >
                  <span class="toggle-slider"></span>
                  <span class="toggle-label">{{ isLimitationsEnabled(user) ? 'Activas' : 'Inactivas' }}</span>
                </label>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="user-details-container" *ngIf="selectedUser">
      <div class="user-details-card">
        <div class="user-details-header">
          <h2>Detalles de Restricciones</h2>
          <div class="user-details-actions" *ngIf="!editMode">
            <button class="btn-edit" (click)="toggleEditMode()">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn-reset" (click)="resetLimitations()">
              <i class="fas fa-redo"></i> Reiniciar contadores
            </button>
          </div>
          <div class="user-details-actions" *ngIf="editMode">
            <button class="btn-save" (click)="updateLimitations()">
              <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn-cancel" (click)="toggleEditMode()">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>
        
        <div class="user-info">
          <h3>{{ selectedUser.username }}</h3>
          <p *ngIf="selectedUser.email">{{ selectedUser.email }}</p>
        </div>
        
        <div class="limitations-form" [class.edit-mode]="editMode">
          <div class="form-group">
            <label>Máximo de apuestas diarias:</label>
            <div class="input-control">
              <input 
                type="number" 
                [(ngModel)]="maxDailyBets" 
                [disabled]="!editMode"
                min="1"
                max="100"
              >
              <span class="input-suffix">apuestas</span>
            </div>
          </div>
          
          <div class="form-group">
            <label>Tiempo máximo de apuestas diario:</label>
            <div class="input-control">
              <input 
                type="number" 
                [(ngModel)]="maxDailyBettingTime" 
                [disabled]="!editMode"
                min="60"
                max="86400"
              >
              <span class="input-suffix">segundos ({{ formatTime(maxDailyBettingTime) }})</span>
            </div>
          </div>
          
          <div class="current-usage">
            <div class="usage-item">
              <span class="usage-label">Apuestas realizadas hoy:</span>
              <span class="usage-value">{{ selectedUser.bets_today }} / {{ selectedUser.max_daily_bets }}</span>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="(selectedUser.bets_today / selectedUser.max_daily_bets) * 100"></div>
              </div>
            </div>
            
            <div class="usage-item">
              <span class="usage-label">Tiempo de apuestas hoy:</span>
              <span class="usage-value">{{ formatTime(selectedUser.betting_time_today) }} / {{ formatTime(selectedUser.max_daily_betting_time) }}</span>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="(selectedUser.betting_time_today / selectedUser.max_daily_betting_time) * 100"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="info-message" *ngIf="!selectedUser.limitations_enabled">
        <i class="fas fa-info-circle"></i>
        <p>Las restricciones están desactivadas para este usuario.</p>
      </div>
    </div>
    
    <div class="select-user-message" *ngIf="!selectedUser">
      <i class="fas fa-user-cog fa-3x"></i>
      <p>Selecciona un usuario para ver y editar sus restricciones</p>
    </div>
  </div>
</div>

<!-- Modal para límites globales -->
<div class="modal-overlay" *ngIf="showGlobalLimitationsModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Establecer Límites Globales</h3>
        <button type="button" class="close" (click)="closeGlobalLimitationsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Estos límites se aplicarán a todos los usuarios que tengan las restricciones activas.</p>
        
        <div class="form-group">
          <label>Máximo de apuestas diarias:</label>
          <div class="input-control">
            <input 
              type="number" 
              [(ngModel)]="globalLimitations.max_daily_bets" 
              min="1"
              max="100"
            >
            <span class="input-suffix">apuestas</span>
          </div>
        </div>
        
        <div class="form-group">
          <label>Tiempo máximo de apuestas diario:</label>
          <div class="input-control">
            <input 
              type="number" 
              [(ngModel)]="globalLimitations.max_daily_betting_time" 
              min="60"
              max="86400"
            >
            <span class="input-suffix">segundos ({{ formatTime(globalLimitations.max_daily_betting_time) }})</span>
          </div>
        </div>
        
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <span>¡Atención! Esta acción no se puede deshacer.</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeGlobalLimitationsModal()">Cancelar</button>
        <button type="button" class="btn-primary" (click)="saveGlobalLimitations()">Aplicar a todos</button>
      </div>
    </div>
  </div>
</div>